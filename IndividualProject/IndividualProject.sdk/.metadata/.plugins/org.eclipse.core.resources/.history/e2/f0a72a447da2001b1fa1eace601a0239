/*
 * tasks.c
 *
 *  Created on: Apr 14, 2021
 *      Author: sebastian
 */

#include "tasks.h"

/*
 * 	Examples of use
 */

/*




*/


/*
 * 	Functions
 */

// Initialization of variables
void initVariables() {
	player_health = 4;
	level = 0;
	move_direction = NONE;
	shot_request = NONE;
	power_up = NONE;
	small_kills = 0;
	medium_kills = 0;
	big_kills = 0;

	cannon = draw_cannon((position_t){4, 1});
}

// Reads the potentiometer value and sets the Run-to-Complete Scheduler timing with it.
void potentiometerTask() {
	u16 temp_data;
	temp_data = getXAdcAuxData(POT_CH);

	tick_value = 100 - (temp_data >> 6);
}

// Reads joystick analog value and button value and set movement and shooting with it.
void joystickTask(int GYRO_GPIO_ID) {
	u16 temp_data;
	u8 temp_btn;

	temp_data = getXAdcAuxData(GYRO_X_CH);
	temp_btn = readGpio(GYRO_GPIO_ID);

	if (temp_data > 3048) {
		move_direction = LEFT;
	} else if (temp_data < 1048) {
		move_direction = RIGHT;
	} else {
		move_direction = NONE;
	}

	shot_request = !temp_btn;
}

// Sets the colors of the background depending on level
void backgroundTask() {
	u16 color_level = 255 - level * 51;
	for (int row = 1; row < NUMBER_OF_ROWS+1; row++) {
		for (int column = 1; column < NUMBER_OF_COLS+1; column++) {
			if (row == 1 || row == 2) {
				writePixelValueDirect(column, row, 0, 255, 0);
			} else {
				setPixelValue(column, row, 0, 0, color_level);
			}
		}
	}
}

// Handles timing and moving sprites, as well as checking for collision.
// Can be seen as main game logic task.
void spritesTask() {

	if (move_direction == RIGHT) {
		move_right_cannon(&cannon);
	} else if (move_direction == LEFT) {
		move_left_cannon(&cannon);
	} else {
		update_cannon(&cannon);
	}

	if (shot_request && !bullet.active) {
		bullet = draw_bullet((position_t){cannon.head.x, cannon.head.y+1});
		smalls[0] = draw_small((position_t){2, 8});
	} else if (bullet.active) {
		move_up_bullet(&bullet);
	}

	move_down_small(&smalls[0]);

}

// Writes values to the matrix once background and sprites are set.
void matrixTask() {
	writeAllPixelsToDevice();
}

// Handles updating the level and player HP, as well as writing statistics.
void levelTask(int LED_GPIO_ID) {

	if (level < 5 && (small_kills+medium_kills+big_kills) > level*10) {
		level++;
	}

	if (player_health == 4) {
		writeGpio(LED_GPIO_ID, LED_1 | LED_2 | LED_3 | LED_4);
	} else if (player_health == 3) {
		writeGpio(LED_GPIO_ID, LED_1 | LED_2 | LED_3);
	} else if (player_health == 2) {
		writeGpio(LED_GPIO_ID, LED_1 | LED_2);
	} else if (player_health == 1) {
		writeGpio(LED_GPIO_ID, LED_1);
	} else {
		writeGpio(LED_GPIO_ID, 0);
		game_over = 1;
	}

	writeLevel(level);
	writeSmallKills(small_kills);
	writeMedKills(medium_kills);
	writeBigKills(big_kills);
	writeHealth(player_health);
	writePowerUp(power_up);
}
